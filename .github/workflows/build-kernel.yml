name: A编译内核

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      kernelsu_variant:
        description: "选择 KernelSU"
        required: true
        type: choice
        options:
          - Official
          - Next
          - MKSU
          - SukiSU
        default: SukiSU
      kernelsu_branch:
        description: "选择 ksu 分支"
        required: true
        type: choice
        options:
          - Stable(标准)
          - Dev(开发)
          - Other(其他/指定)
        default: Dev(开发)
      version:
        description: '自定义版本后缀，留空随机生成' # 更新了描述
        required: false
        type: string # 用户输入的是字符串
      use_zram:
        description: '是否开启增加更多ZRAM算法?'
        required: true
        type: boolean # 输入是布尔型
        default: true
      use_kpm:
        description: '是否开启KPM功能?'
        required: true
        type: boolean # 输入是布尔型
        default: true

jobs:
  prepare_version_string: # 新作业：准备版本字符串
    runs-on: ubuntu-latest
    outputs:
      final_version: ${{ steps.generate_version.outputs.version_string }} # 输出的变量名
    steps:
      - name: Generate or Use Custom Version String
        id: generate_version
        env:
          # 从 workflow_dispatch 的 inputs 中获取用户输入的 version
          USER_PROVIDED_VERSION: ${{ github.event.inputs.version }}
        run: |
          VERSION_TO_USE=""
          if [[ -n "$USER_PROVIDED_VERSION" ]]; then
            # 如果用户提供了 version 输入，则直接使用它
            echo "使用用户提供的版本字符串: $USER_PROVIDED_VERSION"
            VERSION_TO_USE="$USER_PROVIDED_VERSION"
          else
            # 如果用户未提供 version 输入，则生成随机版本字符串
            echo "未提供版本字符串，正在生成随机版本字符串..."
            FIXED_PART="-android14-11"
            PREFIX1="gd"
            PREFIX2="ab"
            # 生成11位随机十六进制字符 (a-f, 0-9)
            RANDOM_HEX=$(head /dev/urandom | LC_ALL=C tr -dc 'a-f0-9' | head -c 11 || true)
            # 生成8位随机数字 (0-9)
            RANDOM_DIGITS=$(head /dev/urandom | LC_ALL=C tr -dc '0-9' | head -c 8 || true)
            VERSION_TO_USE="${FIXED_PART}-${PREFIX1}${RANDOM_HEX}-${PREFIX2}${RANDOM_DIGITS}"
            echo "生成的随机版本字符串: $VERSION_TO_USE"
          fi
          echo "version_string=${VERSION_TO_USE}" >> "$GITHUB_OUTPUT"

  build-kernel-a14-6-1:
    needs: [prepare_version_string] # <--- 依赖 prepare_version_string 作业
    uses: ./.github/workflows/kernel-a14-6.1.yml
    secrets: inherit
    with:
      make_release: false
      kernelsu_variant: ${{ inputs.kernelsu_variant }}
      kernelsu_branch: ${{ inputs.kernelsu_branch }}
      version: ${{ needs.prepare_version_string.outputs.final_version }} # <--- 使用上一个作业生成的版本字符串
      use_zram: ${{ inputs.use_zram }} # <--- 直接传递布尔值
      use_kpm: ${{ inputs.use_kpm }}   # <--- 直接传递布尔值